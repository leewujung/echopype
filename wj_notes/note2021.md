# Echopype dev notes: Jan 2021

## 2021/01/10
### Items still need attention:
- change set to save globally
- combing complex and power/angle data in 1 file for EK80 and EA640
- methods related to combining files:
    - _get_combined_save_path
    - _perform_combination
    - _remove_files
- check combine_files for AZFP --> done

Have not done:
- export XML or ENV options
- update_platform
    
    
Originally in SetGroupsEK80.set_beam()
```python
        # TODO: Check convention to see what to do with the variables below:
        #  'non_quantitative_processing': (['frequency'], beam_dict['non_quantitative_processing'],
        #                                  {'flag_meanings': 'no_non_quantitative_processing',
        #                                   'flag_values': '0',
        #                                   'long_name': 'Presence or not of non-quantitative '
        #                                                'processing applied to the backscattering '
        #                                                'data (sonar specific)'}),
        #  'sample_time_offset': (['frequency'], beam_dict['sample_time_offset'],
        #                         {'long_name': 'Time offset that is subtracted from the timestamp '
        #                                       'of each sample',
        #                          'units': 's'}),
        #  'transmit_bandwidth': (['frequency'], tx_sig['transmit_bandwidth'],
        #                         {'long_name': 'Nominal bandwidth of transmitted pulse',
        #                          'units': 'Hz',
        #                          'valid_min': 0.0}),
```



## 2021/01/27
### Process overhaul
Use case: ensure compatibility with v0.4.1, aim for minimum work:
- Calibration (to Sv)
  ```python
  import echopype as ep
  echodata = ep.EchoData(converted_raw_path='some_path_to_converted_raw_data_files', 
                         data_type='raw')  # specify data type: raw or Sv
  env_params = {'salinity': 35, 'pressure': 200}  # env params for sound speed and absorption
  cal_params = {'DS': 50, 'VTX': 100}  # cal params
  calibration
  # use echopype default or values from data file (depending on each sonar model)
  Sv = ep.calibrate.compute_Sv(echodata)
  # use user-specified parameters
  Sv = ep.calibrate.compute_Sv(echodata, env_params=env_params, cal_params=cal_params)

  # save Sv directly (using xarray function)
  Sv.to_zarr(Sv_file_path)

  # update echodata object
  echodata.set_Sv(Sv)  # by pointing to dataset in memory
  echodata.set_Sv(Sv_file_path)  # by pointing to data already stored somewhere

  # save Sv through echodata object
  echodata.Sv.to_zarr(Sv_file_path)


  calibration
  Sp = ep.calibrate.compute_Sp(echodata)
  TS = ep.calibrate.compute_TS(echodata, target_loc)  # TS is a DataArray with coordinates loc and freq
  ``` 




Jérémie HABASQUE
11:40:01 converting file bassin0120113008.01A with bassin0120113008.xml, time of first ping 2020-Nov-30 08:14:48
C:\Users\jhabasqu\Anaconda3\lib\site-packages\echopype\convert\azfp.py:455: VisibleDeprecationWarning: Creating an ndarray from ragged nested sequences (which is a list-or-tuple of lists-or-tuples-or ndarrays with different lengths or shapes) is deprecated. If you meant to do this, you must specify 'dtype=object' when creating the ndarray
  np.array(N)




## 2021/02/22
- next step: putting in _cal_complex now that all underlying components are ready



## 2021/03/01
- currently using `EchoDataNew` under the hood for `compute_Sv/Sp`
  - there is some inefficiency to this 



## 2021/03/08
- need to generate a new AZFP test dataset with TS and TS-specific range
- need to generate a new AZFP test dataset with Sv and Sv-specific range


# 2021/04/18
- change setgroups methods to return xr.Dataset
- remove `save` function in setgroups, consider having a similar function as part of EchoData
- remove `self.sonar_model` in SetGroups after remove `save`, since it is the only place that is used, and having this parameter also breaks the class inheritance
- the following params in SetGroups needs to be set before to_zarr/netcdf
  - ui_param
  - engine
  - output_path
- change input_file to input_path for SetGroups

Test updates:
- can change all test_convert functions to test EchoData groups directly instead of having to save data to file and then read them back in
- test_calibrate currently uses ep.convert.open_raw --> change to ep.open_raw

- `Convert._conversion_params`
  - `Convert.set_param` can potentially be removed since users can modify directly from EchoData object
  - `_conversion_params` is used when setting up multiple groups but it may be better


- currently not including `data_type` in `to_netcdf/zarr`

- clean up `data_type` in file parsing and conversion
  - ALL is still the default
  - GPS and ENV are now not needed since they are organized in EchoData attributes already and users can do xr.Dataset.to_zarr/netcdf() directly
  - **export CONFIG to XML is still needed**

- consider moving `EchoData._validate_path` to under `utils.io`

